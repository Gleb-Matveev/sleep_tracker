<section class="card">
  <div class="card-header">
    <h1 class="card-title">Edit sleep day</h1>
    <span class="badge-pill">Last nights</span>
  </div>

  <p class="card-subtitle">
    Update your sleep stats for the selected date.
  </p>

  <form action="/day/{{day.id}}" method="post" style="margin-top: 1rem; display: grid; gap: 0.9rem;" id="day-form">
    <div style="display: grid; gap: 0.8rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
      <div>
        <label for="date" class="card-subtitle" style="display: block; margin-bottom: 0.35rem;">Date</label>
        <input id="date" name="date" type="date" value="{{day.date}}" required>
      </div>
      <div>
        <label for="wakeUpTime" class="card-subtitle" style="display: block; margin-bottom: 0.35rem;">Wake up time</label>
        <input id="wakeUpTime" name="wakeUpTime" type="time" value="{{day.wakeUpTime}}" required>
      </div>
      <div>
        <label for="wakeDownTime" class="card-subtitle" style="display: block; margin-bottom: 0.35rem;">Bed time</label>
        <input id="wakeDownTime" name="wakeDownTime" type="time" value="{{day.wakeDownTime}}" required>
      </div>
    </div>

    <div style="display: grid; gap: 0.8rem; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
      <div>
        <label for="getup_score" class="card-subtitle" style="display: block; margin-bottom: 0.35rem;">GetUp score (0-10)</label>
        <input id="getup_score" name="getup_score" type="number" min="0" max="10" step="0.1" value="{{day.getup_score}}" required>
      </div>
      <div>
        <label for="feeling_score" class="card-subtitle" style="display: block; margin-bottom: 0.35rem;">Feeling score (0-10)</label>
        <input id="feeling_score" name="feeling_score" type="number" min="0" max="10" step="0.1" value="{{day.feeling_score}}" required>
      </div>
    </div>

    <div>
      <label for="description" class="card-subtitle" style="display: block; margin-bottom: 0.35rem;">Notes</label>
      <textarea id="description" name="description" rows="3" placeholder="How you slept, what helped or disturbed?">{{day.description}}</textarea>
    </div>

    <div class="form_label">
      <label for="description" class="card-subtitle" style="display: block; margin-bottom: 0.35rem;">Routines completed</label>
      <div class="multiselect_block">
        <label for="select-1" class="field_multiselect">Your routines</label>
        <input id="checkbox-1" class="multiselect_checkbox" type="checkbox">
        <label for="checkbox-1" class="multiselect_label"></label>
        <select id="select-1" class="field_select" name="technology" multiple style="@media (min-width: 768px) { height: calc(4 * 38px)}">
          {{#each day.routines}}
             <option routineid={{this.id}}>{{this.name}}</option>
          {{/each}}
        </select>
      </div>
      <span class="error_text"></span>
    </div>

    <div style="display: flex; gap: 0.6rem; justify-content: flex-end;">
      <a class="btn btn-secondary" href="/day">Cancel</a>
      <button class="btn" type="submit">Update day</button>
    </div>
  </form>
</section>

<script id="day-edit-data" type="application/json">
{
  "selectedRoutineIds": {{json day.selectedRoutineIds}}
}
</script>

<script>
  (() => {
    const dayData = JSON.parse(document.getElementById('day-edit-data').textContent);
    const selectedIds = dayData.selectedRoutineIds || [];

    let multiselect_block = document.querySelectorAll(".multiselect_block");
    const label = document.querySelector('.field_multiselect');
    const select = document.querySelector('.field_select');
    let text = label.innerHTML;

    if (selectedIds.length != 0)
    {
     label.innerHTML = " ";
      Array.from(select.options).forEach(option => {
        const routineId = parseInt(option.getAttribute('routineid'));
        if (selectedIds.includes(routineId)) {
          option.selected = true;
          let button = document.createElement("button");
          button.type = "button";
          button.textContent = option.value;
          button.setAttribute("routineid", option.getAttribute("routineid"));
          button.onclick = _ => {
              option.selected = false;
              button.remove();
              if (!select.selectedOptions.length) label.innerHTML = text
          };
          label.append(button);
        }
      });
    }

    select.addEventListener("change", function(element) {
            let selectedOptions = this.selectedOptions;
            label.innerHTML = "";
            for (let option of selectedOptions) {
                let button = document.createElement("button");
                button.type = "button";
                button.textContent = option.value;
                button.setAttribute("routineid", option.getAttribute("routineid"));
                button.onclick = _ => {
                    option.selected = false;
                    button.remove();
                    if (!select.selectedOptions.length) label.innerHTML = text
                };
                label.append(button);
            }
        });

    document.getElementById('day-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      const buttons = document.querySelectorAll('.field_multiselect button[routineid]');
      const routineIds = Array.from(buttons).map(button => 
          button.getAttribute('routineid')
      ).filter(id => id && id.trim());
      
      const data = {
        date: formData.get('date'),
        wakeUpTime: formData.get('wakeUpTime'),
        wakeDownTime: formData.get('wakeDownTime'),
        getup_score: formData.get('getup_score'),
        feeling_score: formData.get('feeling_score'),
        description: formData.get('description'),
        routineIds: routineIds,
      };

      await fetch(form.action, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      
      window.location.href = '/day';
    });
  })();
</script>

