<!DOCTYPE html>
<html lang="ru">
    {{> head }}
<body>
    <div class="app-root">
        {{> navbar }}
        <main class="main">
            <div class="main-inner">
                {{{ body }}}
            </div>
        </main>
        {{> footer }}
    </div>

    <div id="confirm-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal">
            <h2 class="modal-title">Confirm action</h2>
            <p class="modal-message">Are you sure you want to delete this item?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary modal-cancel">Cancel</button>
                <button type="button" class="btn modal-confirm">Delete</button>
            </div>
        </div>
    </div>

    <script>
      (() => {
        const overlay = document.getElementById('confirm-overlay');
        if (!overlay) return;

        const cancelBtn = overlay.querySelector('.modal-cancel');
        const confirmBtn = overlay.querySelector('.modal-confirm');
        const messageEl = overlay.querySelector('.modal-message');

        let current = {
          trigger: null,
          url: null,
          removeClosest: null,
        };

        const close = () => {
          overlay.style.display = 'none';
          current = { trigger: null, url: null, removeClosest: null };
        };

        const open = (trigger, url, removeClosest, message) => {
          current.trigger = trigger;
          current.url = url;
          current.removeClosest = removeClosest;
          if (messageEl && message) {
            messageEl.textContent = message;
          }
          overlay.style.display = 'flex';
        };

        document.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;

          // delegate delete trigger
          const btn = target.closest('.js-delete-trigger');
          if (btn) {
            event.preventDefault();
            const url = btn.getAttribute('data-delete-url');
            const removeClosest = btn.getAttribute('data-remove-closest');
            const message = btn.getAttribute('data-delete-message') || 'Are you sure you want to delete this item?';
            if (!url) return;
            open(btn, url, removeClosest, message);
            return;
          }

          // close when clicking on backdrop
          if (target.classList.contains('modal-backdrop')) {
            close();
          }
        });

        cancelBtn?.addEventListener('click', (event) => {
          event.preventDefault();
          close();
        });

        confirmBtn?.addEventListener('click', (event) => {
          event.preventDefault();
          if (!current.url) {
            close();
            return;
          }

          fetch(current.url, { method: 'DELETE' })
            .then(() => {
              if (current.removeClosest && current.trigger instanceof HTMLElement) {
                const el = current.trigger.closest(current.removeClosest);
                if (el) {
                  el.remove();
                  return;
                }
              }
              window.location.reload();
            })
            .finally(() => {
              close();
            });
        });
      })();
    </script>
</body>
</html>